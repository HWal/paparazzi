<!DOCTYPE airframe SYSTEM "airframe.dtd">

<!-- File name elle0hw.xml
     XBee PRO Series 2 or Aerocomm AC4790 modem
     Autopilot:   Elle0 1.2 with STM32F4
     IMU:         Onboard MPU9250 Gyro + Accelerometer + Compass
     Baro:        Onboard MS5611
     Actuators:   PWM servos
     GPS:         Ublox 6
     RC:          CPPM Rx -->

<airframe name="elle0hw.xml">

<!-- INFO "define" is a C preprocessor directive, "configure" produces a makefile variable -->
 <firmware name="fixedwing">
    <target name="ap"                                board="elle0_1.2">
      <!-- <configure name="LISA_M_BARO"                  value="BARO_MS5611_I2C"/> -->
      <!-- <configure name="USE_BARO_BOARD"               value="TRUE"/> --><!-- default if board has baro -->
      <!-- <define name="USE_BAROMETER"                   value="TRUE"/> --><!-- if ins_alt_float is used -->
      <!-- <configure name="PERIODIC_FREQUENCY"           value="120"/> -->
      <!-- <configure name="AHRS_PROPAGATE_FREQUENCY"     value="100"/> -->
      <!-- <configure name="AHRS_CORRECT_FREQUENCY"       value="100"/> -->
      <!-- <define name="AHRS_TRIGGERED_ATTITUDE_LOOP" /> -->
      <!-- <configure name="AHRS_ALIGNER_LED"             value="3"/> -->
      <!-- <configure name="CPU_LED"                      value="3"/> -->
      <!-- <define name="I2C2_CLOCK_SPEED"                value="100000"/> --><!-- on stm32 -->
      <!-- <define name="SENSOR_SYNC_SEND"/> -->
      <!-- <define name="TELEMETRY_MODE_AP"          value="3"/> -->
      <!-- <define name="TELEMETRY_MODE_FBW"         value="1"/> -->
      <define name="PERIOD_NAVIGATION_0"/><!-- stop NAVIGATION msg in main_ap.c -->
    </target>

    <target name="sim" 			             board="pc"/>

    <!-- Global firmware defines -->
    <define name="LOITER_TRIM"/>
    <define name="AGR_CLIMB"/>
    <define name="WIND_INFO"/>
    <define name="WIND_INFO_RET"/>
    <define name="STRONG_WIND"/>

    <!-- Sensors -->
    <module name="gps"           type="ublox"/>
    <module name="imu"           type="elle0"/>
    <module name="ahrs"          type="int_cmpl_quat">
       <configure name="USE_MAGNETOMETER" value="0"/>
       <define name="AHRS_USE_GPS_HEADING" value="1"/>
       <define name="AHRS_GRAVITY_UPDATE_COORDINATED_TURN"/>
    </module>
<!-- <module name="ahrs" type="float_dcm">
       <configure name="USE_MAGNETOMETER" value="0"/>
       <define name="USE_HIGH_ACCEL_FLAG"/>
    </module> -->

    <!-- Radio Control -->
    <module name="radio_control" type="ppm">
       <!-- <configure name="RADIO_CONTROL_PPM_PIN" value="UART1_RX"/> -->
       <configure name="RADIO_CONTROL_PPM_PIN" value="SERVO6"/>
    </module>

    <!-- Communication -->
    <module name="telemetry"     type="transparent"/>

    <!-- Navigation -->
    <module name="navigation"/>

    <!-- Actuators -->
    <module name="control"/>

    <module name="ins" type="alt_float">
       <define name="USE_BAROMETER" value="TRUE"/>
    </module>
    <module name="air_data.xml">
       <define name="AIR_DATA_CALC_AMSL_BARO" value="TRUE"/>
    </module>
 </firmware>

<!-- <firmware name="setup">
    <target name="tunnel"           board="elle0_1.2"/>
    <target name="usb_tunnel"       board="elle0_1.2">
      <configure name="TUNNEL_PORT" value="UART3"/>
    </target>
    <target name="setup_actuators"  board="elle0_1.2">
      <module name="actuators" type="pwm"/>
      <define name="SERVO_HZ" value="400"/>
      <define name="USE_SERVOS_7AND8"/>
    </target>
 </firmware> -->

 <modules>
 <!-- Here only modules with specific non-default main_freq attribute
    (default is autopilot main frequency. -->
 </modules>

  <!-- commands section -->
  <servos>
    <servo name="AILERON"       no="0" min="1107" neutral="1523" max="1932"/><!-- SERVO1 on Elle0 -->
    <servo name="ELEVATOR"      no="1" min="1107" neutral="1519" max="1932"/><!-- .. and so on ... -->
    <servo name="MOTOR"         no="2" min="1929" neutral="1929" max="1107"/>
    <servo name="RUDDER"        no="3" min="1932" neutral="1521" max="1107"/>
    <servo name="HATCH"         no="4" min="964"  neutral="1489" max="2070"/>
  </servos>

  <commands>
    <axis name="ROLL"      failsafe_value="0"/>
    <axis name="PITCH"     failsafe_value="0"/>
    <axis name="THROTTLE"  failsafe_value="0"/>
    <axis name="YAW"       failsafe_value="0"/>
    <axis name="HATCH"     failsafe_value="0"/>
  </commands>

  <rc_commands>
    <set command="ROLL"     value="@ROLL"/>
    <set command="PITCH"    value="@PITCH"/>
    <set command="THROTTLE" value="@THROTTLE"/>
    <set command="YAW"      value="@YAW"/>
    <set command="HATCH"    value="@EXTRA_1"/>
  </rc_commands>

  <!-- Define servos that can be controlled by RC in AUTO1 and AUTO2 -->
  <!-- YAW is default but included here -->
  <auto_rc_commands>
    <set command="YAW" value="@YAW"/>
  </auto_rc_commands>

  <section name="MIXER">
    <!-- <define name="AILERON_DIFF" value="0.8"/> -->
    <!-- COMBI_SWITCH is an internal parameter to mix in RUDDER movement as a result of AILERON INPUT -->
    <define name="COMBI_SWITCH" value="0.15"/>
  </section>

  <command_laws>
    <set servo="AILERON"       value="@ROLL"/>
    <set servo="ELEVATOR"      value="@PITCH"/>
    <set servo="MOTOR"         value="@THROTTLE"/>
    <set servo="RUDDER"        value="@YAW + @ROLL*COMBI_SWITCH"/>
    <set servo="HATCH"         value="@HATCH"/>
  </command_laws>

  <section name="AUTO1" prefix="AUTO1_">
    <define name="MAX_ROLL" value="1.0" unit="rad"/>
    <define name="MAX_PITCH" value="0.7" unit="rad"/>
  </section>

  <!-- Local Magnetic field - when Magnetometer is used -->
  <section name="AHRS" prefix="AHRS_">
    <define name="H_X" value="0.51562740288882"/>
    <define name="H_Y" value="-0.05707735220832"/>
    <define name="H_Z" value="0.85490967783446"/>
  </section>

  <section name="IMU" prefix="IMU_">
<!-- Default signs used for elle0
    <define name="GYRO_P_SIGN" value="-1"/>
    <define name="GYRO_Q_SIGN" value="-1"/>
    <define name="GYRO_R_SIGN" value="1"/>
    <define name="ACCEL_X_SIGN" value="-1"/>
    <define name="ACCEL_Y_SIGN" value="-1"/>
    <define name="ACCEL_Z_SIGN" value="1"/> -->

    <define name="GYRO_P_NEUTRAL" value="0"/>
    <define name="GYRO_Q_NEUTRAL" value="0"/>
    <define name="GYRO_R_NEUTRAL" value="0"/>
    <!-- SENS = 16.4 LSB/(deg/sec) * 57.6 deg/rad = 939.650 LSB/rad/sec / 12bit FRAC: 4096 / 939.65 -->
    <define name="GYRO_P_SENS" value="4.359" integer="16"/>
    <define name="GYRO_Q_SENS" value="4.359" integer="16"/>
    <define name="GYRO_R_SENS" value="4.359" integer="16"/>

    <define name="ACCEL_X_NEUTRAL" value="60"/>
    <define name="ACCEL_Y_NEUTRAL" value="40"/>
    <define name="ACCEL_Z_NEUTRAL" value="140"/>
    <define name="ACCEL_X_SENS" value="4.92297204167" integer="16"/>
    <define name="ACCEL_Y_SENS" value="4.88255070466" integer="16"/>
    <define name="ACCEL_Z_SENS" value="4.86606505696" integer="16"/>

    <define name="MAG_X_NEUTRAL" value="0"/>
    <define name="MAG_Y_NEUTRAL" value="0"/>
    <define name="MAG_Z_NEUTRAL" value="0"/>
    <define name="MAG_X_SENS" value="1" integer="16"/>
    <define name="MAG_Y_SENS" value="1" integer="16"/>
    <define name="MAG_Z_SENS" value="1" integer="16"/>

    <define name="BODY_TO_IMU_PHI" value="1.7" unit="deg"/><!-- correction around bank axis -->
    <define name="BODY_TO_IMU_THETA" value="2.5" unit="deg"/><!-- correction around pitch axis -->
    <define name="BODY_TO_IMU_PSI" value="90.0" unit="deg"/><!-- correction around yaw axis -->
  </section>

  <section name="INS" prefix="INS_">
    <define name="ROLL_NEUTRAL_DEFAULT" value="0" unit="deg"/>
    <define name="PITCH_NEUTRAL_DEFAULT" value="0" unit="deg"/>
  </section>

  <section name="BAT">
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="37000"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="9.0" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="9.8" unit="V"/>
    <define name="LOW_BAT_LEVEL" value="10.4" unit="V"/>
    <define name="MAX_BAT_LEVEL" value="12.6" unit="V"/>
  </section>


  <section name="MISC">
    <!-- NOMINAL_AIRSPEED is mainly used in the simulator -->
    <define name="NOMINAL_AIRSPEED" value="14." unit="m/s"/>
    <!-- <define name="MINIMUM_AIRSPEED" value="10." unit="m/s"/> -->
    <!-- <define name="MAXIMUM_AIRSPEED" value="20." unit="m/s"/> -->
    <define name="CARROT" value="3." unit="s"/>
    <define name="KILL_MODE_DISTANCE" value="(1.5*MAX_DIST_FROM_HOME)"/>
    <define name="CONTROL_FREQUENCY" value="60" unit="Hz"/><!-- 60 is default -->
    <define name="DEFAULT_CIRCLE_RADIUS" value="60."/>
    <!-- <define name="RC_LOST_MODE" value="AP_MODE_AUTO2"/> -->
    <!-- UNLOCKED_HOME_MODE=TRUE can change mode with RC switch after entering HOME mode -->
    <define name="UNLOCKED_HOME_MODE" value="TRUE"/>
    <!-- <define name="XBEE_INIT" value="\"ATPL2\rATRN1\rATTT80\r\""/> --><!-- For API protocol only -->
    <define name="NO_XBEE_API_INIT" value="TRUE"/>
    <!-- <define name="GLIDE_AIRSPEED" value="10"/> -->
    <!-- <define name="GLIDE_VSPEED" value="3."/> -->
    <!-- <define name="GLIDE_PITCH" value="45" unit="deg"/> -->
    <define name="COMMAND_ROLL_TRIM" value="0."/><!-- Default=0 -->
    <define name="COMMAND_PITCH_TRIM" value="0."/><!-- Default=0 -->
  </section>

  <section name="VERTICAL CONTROL" prefix="V_CTL_">
    <!-- The below definition affect the throttle percentage shown on the GCS -->
    <define name="POWER_CTL_BAT_NOMINAL" value="11.1" unit="volt"/>

    <!-- outer loop proportional gain -->

    <define name="ALTITUDE_PGAIN" value="0.1" unit="(m/s)/m"/>
    <!-- Climb command in m/s = Altitude error * ALTITUDE_PGAIN -->

    <!-- outer loop saturation - limitation of Climb command -->
    <define name="ALTITUDE_MAX_CLIMB" value="6." unit="m/s"/>

    <!-- auto throttle inner loop -->
    <define name="AUTO_THROTTLE_NOMINAL_CRUISE_THROTTLE" value="0.45" unit="%"/>

    <!-- The Loiter button changes NOMINAL_CRUISE_THROTTLE to MIN_CRUISE_THROTTLE -->
    <define name="AUTO_THROTTLE_MIN_CRUISE_THROTTLE" value=".30" unit="%"/>
    <!-- The Dash button changes NOMINAL_CRUISE_THROTTLE to MAX_CRUISE_THROTTLE -->
    <define name="AUTO_THROTTLE_MAX_CRUISE_THROTTLE" value=".80" unit="%"/>
    <!-- AUTO_THROTTLE_LOITER_TRIM gives elevator trim when the Loiter button is pushed -->
    <define name="AUTO_THROTTLE_LOITER_TRIM" value="1000" unit="pprz_t"/>
    <!-- AUTO_THROTTLE_DASH_TRIM gives elevator trim when the Dash button is pushed -->
    <define name="AUTO_THROTTLE_DASH_TRIM" value="-1000" unit="pprz_t"/>

    <define name="AUTO_THROTTLE_CLIMB_THROTTLE_INCREMENT" value="0.1" unit="%/(m/s)"/>
    <define name="AUTO_THROTTLE_PGAIN" value="0.02" unit="%/(m/s)"/>
    <define name="AUTO_THROTTLE_IGAIN" value="0.05"/>

    <!-- Pitch command = Climb command * AUTO_THROTTLE_PITCH_OF_VZ_PGAIN -->
    <define name="AUTO_THROTTLE_PITCH_OF_VZ_PGAIN" value="0.05" unit="rad/(m/s)"/>

    <!-- Throttle command = AUTO_THROTTLE_NOMINAL_CRUISE_THROTTLE + Climb command * AUTO_THROTTLE_CLIMB_THROTTLE_INCREMENT -->

    <!-- auto pitch inner loop - see Navigation modes in Flight plan doc in wiki -->
    <!-- Auto pitch is for constant throttle and control of height with elevator only -->
    <define name="AUTO_PITCH_PGAIN" value="0.08"/>
    <define name="AUTO_PITCH_IGAIN" value="0.02"/>
    <define name="AUTO_PITCH_MAX_PITCH" value="0.435" unit="rad"/>
    <define name="AUTO_PITCH_MIN_PITCH" value="-0.435" unit="rad"/>

    <!-- THROTTLE_SLEW_LIMITER = time to change throttle from 0% to 100% -->
    <!-- THROTTLE_SLEW is not needed in airframe file anymore -->
    <define name="THROTTLE_SLEW_LIMITER" value="2." unit="s"/>
  </section>

  <section name="HORIZONTAL CONTROL" prefix="H_CTL_">
    <define name="COURSE_PGAIN" value="0.89"/>
    <define name="COURSE_DGAIN" value="0.27"/>

    <!-- PRE_BANK default is 1.0 - Recommended 0.1 - 2
         0.5 gives less roll and maybe larger circle
         1,5 gives more roll and maybe smaller circle  -->
    <define name="COURSE_PRE_BANK_CORRECTION" value="1.0"/>

    <define name="ROLL_MAX_SETPOINT" value="0.5" unit="rad"/>
    <define name="PITCH_MAX_SETPOINT" value="0.435" unit="rad"/>
    <define name="PITCH_MIN_SETPOINT" value="-0.435" unit="rad"/>

    <define name="AILERON_OF_THROTTLE" value="0.0"/>
    <define name="PITCH_PGAIN" value="12000."/>      <!-- TUDELFT use 16917.3 -->
    <define name="PITCH_DGAIN" value="1.5"/>         <!-- TUDELFT use 7.7 -->
    <define name="ROLL_SLEW" value="1.0"/>           <!-- TUDELFT use 1. -->
    <define name="ELEVATOR_OF_ROLL" value="1250."/>  <!-- TUDELFT use 3007.8 -->
    <define name="ROLL_ATTITUDE_GAIN" value="7400."/><!-- TUDELFT use 11718.8 -->
    <define name="ROLL_RATE_GAIN" value="500."/>     <!-- Only has meaning when GYRO is used -->
  </section>

  <section name="AGGRESSIVE" prefix="AGR_">
    <define name="BLEND_START" value="50"/>        <!-- Altitude Error to Initiate Aggressive Climb - CANNOT BE ZERO!!-->
    <define name="BLEND_END" value="15"/>          <!-- Altitude Error to Blend Aggressive to Regular Climb - CANNOT BE ZERO!!-->
    <define name="CLIMB_THROTTLE" value="0.8"/>   <!-- Throttle for Aggressive Climb -->
    <define name="CLIMB_PITCH" value="0.5"/>       <!-- Pitch for Aggressive Climb -->
    <define name="DESCENT_THROTTLE" value="0.1"/>  <!-- Throttle for Aggressive Descent -->
    <define name="DESCENT_PITCH" value="-0.5"/>   <!-- Pitch for Aggressive Descent -->
    <define name="CLIMB_NAV_RATIO" value="0.8"/>   <!-- Percent Navigation for Altitude Error Equal to Start Altitude -->
    <define name="DESCENT_NAV_RATIO" value="1.0"/>
  </section>

  <section name="NAV">
    <define name="NAV_GLIDE_PITCH_TRIM" value="0"/><!-- DOES NOTHING IN THE CODE -->
  </section>

  <section name="FAILSAFE" prefix="FAILSAFE_">
    <define name="DELAY_WITHOUT_GPS" value="3" unit="s"/>
    <define name="DEFAULT_THROTTLE" value="0.4" unit="%"/>
    <define name="DEFAULT_ROLL" value="0.2" unit="rad"/>
    <define name="DEFAULT_PITCH" value="0.1" unit="rad"/>
    <define name="HOME_RADIUS" value="DEFAULT_CIRCLE_RADIUS" unit="m"/>
    <define name="KILL_MODE_DISTANCE" value="(MAX_DIST_FROM_HOME*1.5)"/>
  </section>

</airframe>
